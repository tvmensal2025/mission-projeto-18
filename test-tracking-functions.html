<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Teste Sistema de Tracking Completo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .test-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
        .test-item.loading {
            border-left-color: #FFC107;
            animation: pulse 1.5s infinite;
        }
        .test-item.error {
            border-left-color: #F44336;
        }
        .test-item.success {
            border-left-color: #4CAF50;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.5s ease;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        .status-icon {
            font-size: 1.2em;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Sistema de Tracking Completo</h1>
        <p class="subtitle">Testando todas as Edge Functions e integra√ß√µes</p>
        
        <div style="text-align: center; margin: 30px 0;">
            <button id="startTest" class="button">üéØ Iniciar Teste Completo</button>
        </div>

        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>

        <div id="testResults">
            <div class="test-section">
                <div class="test-header">
                    <span class="status-icon">üìä</span>
                    <span>1. Tracking Manager</span>
                </div>
                <div id="test1" class="test-item">
                    <div>üíß Registro de √Ågua: <span id="water-status">Aguardando...</span></div>
                    <div>üò¥ Registro de Sono: <span id="sleep-status">Aguardando...</span></div>
                    <div>üòä Registro de Humor: <span id="mood-status">Aguardando...</span></div>
                    <div>üèÉ Registro de Exerc√≠cio: <span id="exercise-status">Aguardando...</span></div>
                </div>
            </div>

            <div class="test-section">
                <div class="test-header">
                    <span class="status-icon">üìà</span>
                    <span>2. Tracking Dashboard</span>
                </div>
                <div id="test2" class="test-item">
                    <div>üìä Overview Geral: <span id="overview-status">Aguardando...</span></div>
                    <div>üìÖ Resumo Di√°rio: <span id="daily-status">Aguardando...</span></div>
                    <div>üìä Estat√≠sticas Semanais: <span id="weekly-status">Aguardando...</span></div>
                </div>
            </div>

            <div class="test-section">
                <div class="test-header">
                    <span class="status-icon">üî¨</span>
                    <span>3. Tracking Analytics</span>
                </div>
                <div id="test3" class="test-item">
                    <div>üå± Dados de Exemplo: <span id="seed-status">Aguardando...</span></div>
                    <div>üìà An√°lise de Tend√™ncias: <span id="trends-status">Aguardando...</span></div>
                    <div>üë®‚Äç‚öïÔ∏è Relat√≥rio Dr. Vital: <span id="drvital-status">Aguardando...</span></div>
                </div>
            </div>

            <div class="test-section">
                <div class="test-header">
                    <span class="status-icon">üîó</span>
                    <span>4. Tracking Integration</span>
                </div>
                <div id="test4" class="test-item">
                    <div>üéØ Sincroniza√ß√£o de Metas: <span id="sync-status">Aguardando...</span></div>
                    <div>üìä Atualiza√ß√£o de Progresso: <span id="progress-status">Aguardando...</span></div>
                    <div>ü§ñ Integra√ß√£o Sofia: <span id="sofia-status">Aguardando...</span></div>
                </div>
            </div>
        </div>

        <div id="finalResults" class="results" style="display: none;">
            <h2>üéØ Resultado Final</h2>
            <div id="finalScore"></div>
            <div id="finalMessage"></div>
        </div>

        <div id="errorLog" class="log" style="display: none;">
            <h3>üìã Log de Erros</h3>
            <div id="errorContent"></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://hlrkoyywjpckdotimtik.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhscmtveXl3anBja2RvdGltdGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUzMzMzNzEsImV4cCI6MjA1MDkwOTM3MX0.5KYY-xZxdBKcJJBJgmVuKQ3HyVGdUcQW1HJlxDvhGWw';
        
        const TEST_USER_ID = 'test-user-tracking-' + Date.now();
        let totalTests = 0;
        let passedTests = 0;
        let errors = [];

        function updateStatus(elementId, status, message = '') {
            const element = document.getElementById(elementId);
            if (element) {
                if (status === 'success') {
                    element.innerHTML = '‚úÖ Sucesso' + (message ? ` - ${message}` : '');
                    element.style.color = '#4CAF50';
                } else if (status === 'error') {
                    element.innerHTML = '‚ùå Erro' + (message ? ` - ${message}` : '');
                    element.style.color = '#F44336';
                } else if (status === 'loading') {
                    element.innerHTML = '‚è≥ Testando...';
                    element.style.color = '#FFC107';
                }
            }
        }

        function updateProgress() {
            const progress = (passedTests / totalTests) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function logError(error) {
            errors.push(error);
            const errorLog = document.getElementById('errorLog');
            const errorContent = document.getElementById('errorContent');
            errorLog.style.display = 'block';
            errorContent.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${error}</div>`;
        }

        async function callFunction(functionName, body) {
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/${functionName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    },
                    body: JSON.stringify(body),
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                throw new Error(`${functionName}: ${error.message}`);
            }
        }

        async function testTrackingManager() {
            console.log('üß™ Testando Tracking Manager...');
            
            // Teste √°gua
            updateStatus('water-status', 'loading');
            try {
                const waterResult = await callFunction('tracking-manager', {
                    action: 'create',
                    type: 'water',
                    userId: TEST_USER_ID,
                    date: new Date().toISOString().split('T')[0],
                    data: {
                        amount_ml: 2500,
                        goal_ml: 2000,
                        cups_count: 10,
                        source: 'test',
                        notes: 'Teste do sistema'
                    }
                });
                
                if (waterResult.success) {
                    updateStatus('water-status', 'success');
                    passedTests++;
                } else {
                    throw new Error(waterResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('water-status', 'error', error.message);
                logError(`√Ågua: ${error.message}`);
            }
            totalTests++;

            // Teste sono
            updateStatus('sleep-status', 'loading');
            try {
                const sleepResult = await callFunction('tracking-manager', {
                    action: 'create',
                    type: 'sleep',
                    userId: TEST_USER_ID,
                    date: new Date().toISOString().split('T')[0],
                    data: {
                        hours: 8.5,
                        quality: 4,
                        bedtime: '23:00',
                        wake_time: '07:30',
                        dream_notes: 'Teste de sono'
                    }
                });
                
                if (sleepResult.success) {
                    updateStatus('sleep-status', 'success');
                    passedTests++;
                } else {
                    throw new Error(sleepResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('sleep-status', 'error', error.message);
                logError(`Sono: ${error.message}`);
            }
            totalTests++;

            // Teste humor
            updateStatus('mood-status', 'loading');
            try {
                const moodResult = await callFunction('tracking-manager', {
                    action: 'create',
                    type: 'mood',
                    userId: TEST_USER_ID,
                    date: new Date().toISOString().split('T')[0],
                    data: {
                        energy_level: 4,
                        stress_level: 2,
                        day_rating: 8,
                        gratitude_note: 'Sistema funcionando!',
                        mood_tags: ['feliz', 'motivado']
                    }
                });
                
                if (moodResult.success) {
                    updateStatus('mood-status', 'success');
                    passedTests++;
                } else {
                    throw new Error(moodResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('mood-status', 'error', error.message);
                logError(`Humor: ${error.message}`);
            }
            totalTests++;

            // Teste exerc√≠cio
            updateStatus('exercise-status', 'loading');
            try {
                const exerciseResult = await callFunction('tracking-manager', {
                    action: 'create',
                    type: 'exercise',
                    userId: TEST_USER_ID,
                    date: new Date().toISOString().split('T')[0],
                    data: {
                        exercise_type: 'cardio',
                        exercise_name: 'Corrida',
                        duration_minutes: 30,
                        calories_burned: 300,
                        intensity: 4,
                        notes: 'Teste de exerc√≠cio'
                    }
                });
                
                if (exerciseResult.success) {
                    updateStatus('exercise-status', 'success');
                    passedTests++;
                } else {
                    throw new Error(exerciseResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('exercise-status', 'error', error.message);
                logError(`Exerc√≠cio: ${error.message}`);
            }
            totalTests++;

            updateProgress();
        }

        async function testTrackingDashboard() {
            console.log('üß™ Testando Tracking Dashboard...');

            // Teste overview
            updateStatus('overview-status', 'loading');
            try {
                const overviewResult = await callFunction('tracking-dashboard', {
                    userId: TEST_USER_ID,
                    type: 'overview'
                });
                
                if (overviewResult.success) {
                    updateStatus('overview-status', 'success', 'Dashboard carregado');
                    passedTests++;
                } else {
                    throw new Error(overviewResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('overview-status', 'error', error.message);
                logError(`Overview: ${error.message}`);
            }
            totalTests++;

            // Teste resumo di√°rio
            updateStatus('daily-status', 'loading');
            try {
                const dailyResult = await callFunction('tracking-dashboard', {
                    userId: TEST_USER_ID,
                    type: 'daily',
                    date: new Date().toISOString().split('T')[0]
                });
                
                if (dailyResult.success) {
                    updateStatus('daily-status', 'success', 'Resumo gerado');
                    passedTests++;
                } else {
                    throw new Error(dailyResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('daily-status', 'error', error.message);
                logError(`Resumo Di√°rio: ${error.message}`);
            }
            totalTests++;

            // Teste estat√≠sticas semanais
            updateStatus('weekly-status', 'loading');
            try {
                const weeklyResult = await callFunction('tracking-dashboard', {
                    userId: TEST_USER_ID,
                    type: 'weekly'
                });
                
                if (weeklyResult.success) {
                    updateStatus('weekly-status', 'success', 'Estat√≠sticas calculadas');
                    passedTests++;
                } else {
                    throw new Error(weeklyResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('weekly-status', 'error', error.message);
                logError(`Estat√≠sticas Semanais: ${error.message}`);
            }
            totalTests++;

            updateProgress();
        }

        async function testTrackingAnalytics() {
            console.log('üß™ Testando Tracking Analytics...');

            // Criar dados de exemplo
            updateStatus('seed-status', 'loading');
            try {
                const seedResult = await callFunction('tracking-analytics', {
                    userId: TEST_USER_ID,
                    type: 'seed_data'
                });
                
                if (seedResult.success) {
                    updateStatus('seed-status', 'success', '30 dias de dados criados');
                    passedTests++;
                } else {
                    throw new Error(seedResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('seed-status', 'error', error.message);
                logError(`Dados de Exemplo: ${error.message}`);
            }
            totalTests++;

            // Teste an√°lise de tend√™ncias
            updateStatus('trends-status', 'loading');
            try {
                const trendsResult = await callFunction('tracking-analytics', {
                    userId: TEST_USER_ID,
                    type: 'trends',
                    period: 'month'
                });
                
                if (trendsResult.success) {
                    updateStatus('trends-status', 'success', 'Tend√™ncias analisadas');
                    passedTests++;
                } else {
                    throw new Error(trendsResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('trends-status', 'error', error.message);
                logError(`Tend√™ncias: ${error.message}`);
            }
            totalTests++;

            // Teste relat√≥rio Dr. Vital
            updateStatus('drvital-status', 'loading');
            try {
                const drVitalResult = await callFunction('tracking-analytics', {
                    userId: TEST_USER_ID,
                    type: 'dr_vital_report'
                });
                
                if (drVitalResult.success) {
                    updateStatus('drvital-status', 'success', 'Relat√≥rio gerado');
                    passedTests++;
                } else {
                    throw new Error(drVitalResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('drvital-status', 'error', error.message);
                logError(`Dr. Vital: ${error.message}`);
            }
            totalTests++;

            updateProgress();
        }

        async function testTrackingIntegration() {
            console.log('üß™ Testando Tracking Integration...');

            // Teste sincroniza√ß√£o de metas
            updateStatus('sync-status', 'loading');
            try {
                const syncResult = await callFunction('tracking-integration', {
                    action: 'sync_goals',
                    userId: TEST_USER_ID
                });
                
                if (syncResult.success) {
                    updateStatus('sync-status', 'success', 'Metas sincronizadas');
                    passedTests++;
                } else {
                    throw new Error(syncResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('sync-status', 'error', error.message);
                logError(`Sincroniza√ß√£o: ${error.message}`);
            }
            totalTests++;

            // Teste atualiza√ß√£o de progresso
            updateStatus('progress-status', 'loading');
            try {
                const progressResult = await callFunction('tracking-integration', {
                    action: 'update_progress',
                    userId: TEST_USER_ID,
                    data: {
                        water: { amount_ml: 3000, goal_ml: 2000 },
                        mood: { energy_level: 5, day_rating: 9 }
                    }
                });
                
                if (progressResult.success) {
                    updateStatus('progress-status', 'success', 'Progresso atualizado');
                    passedTests++;
                } else {
                    throw new Error(progressResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('progress-status', 'error', error.message);
                logError(`Progresso: ${error.message}`);
            }
            totalTests++;

            // Teste integra√ß√£o Sofia
            updateStatus('sofia-status', 'loading');
            try {
                const sofiaResult = await callFunction('tracking-integration', {
                    action: 'sofia_chat',
                    userId: TEST_USER_ID,
                    data: {
                        message: 'Como est√° meu progresso de sa√∫de hoje?'
                    }
                });
                
                if (sofiaResult.success) {
                    updateStatus('sofia-status', 'success', 'Sofia integrada');
                    passedTests++;
                } else {
                    throw new Error(sofiaResult.error || 'Erro desconhecido');
                }
            } catch (error) {
                updateStatus('sofia-status', 'error', error.message);
                logError(`Sofia: ${error.message}`);
            }
            totalTests++;

            updateProgress();
        }

        async function runCompleteTest() {
            const startButton = document.getElementById('startTest');
            startButton.disabled = true;
            startButton.textContent = 'üß™ Testando...';

            totalTests = 0;
            passedTests = 0;
            errors = [];

            try {
                await testTrackingManager();
                await testTrackingDashboard();
                await testTrackingAnalytics();
                await testTrackingIntegration();

                // Mostrar resultado final
                const successRate = Math.round((passedTests / totalTests) * 100);
                const finalResults = document.getElementById('finalResults');
                const finalScore = document.getElementById('finalScore');
                const finalMessage = document.getElementById('finalMessage');

                finalResults.style.display = 'block';
                finalScore.innerHTML = `<h3>üéØ Taxa de Sucesso: ${passedTests}/${totalTests} (${successRate}%)</h3>`;

                if (successRate >= 80) {
                    finalMessage.innerHTML = `
                        <div style="color: #4CAF50; font-size: 1.2em;">
                            üéâ <strong>SISTEMA DE TRACKING 100% FUNCIONAL!</strong><br>
                            üöÄ Todas as Edge Functions est√£o operacionais!<br>
                            ü§ñ Sofia agora tem acesso completo aos dados de tracking!<br>
                            üë®‚Äç‚öïÔ∏è Dr. Vital pode gerar relat√≥rios detalhados!<br><br>
                            <strong>Pr√≥ximos passos:</strong><br>
                            1. Integrar com o frontend React<br>
                            2. Criar componentes de UI para tracking<br>
                            3. Implementar notifica√ß√µes e lembretes<br>
                            4. Configurar relat√≥rios autom√°ticos
                        </div>
                    `;
                } else {
                    finalMessage.innerHTML = `
                        <div style="color: #FFC107; font-size: 1.1em;">
                            ‚ö†Ô∏è <strong>Alguns componentes precisam de ajustes</strong><br>
                            Verifique os logs de erro abaixo para mais detalhes.
                        </div>
                    `;
                }

            } catch (error) {
                logError(`Erro geral: ${error.message}`);
            }

            startButton.disabled = false;
            startButton.textContent = 'üîÑ Testar Novamente';
        }

        // Event listener
        document.getElementById('startTest').addEventListener('click', runCompleteTest);
    </script>
</body>
</html>